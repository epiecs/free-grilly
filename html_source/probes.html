<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Free Grilly</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="icon" href="data:,">
  </head>
  <body>
    <nav class="navbar navbar-expand bg-body-tertiary">
        <div class="container-fluid">
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" aria-current="page" href="/">Temperatures</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/probes">Probes</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/settings">Settings</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/about">About</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/update">Update</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container">
        <!-- <div class="row pt-1 row-cols-2 row-cols-sm-2 row-cols-md-2 row-cols-lg-4 g-2"> -->
        <div class="row">
            <div class="my-2 col-sm-12">
                <div id="alert" class="alert alert-dismissible fade show" style="display: none;" role="alert">
                    <span id="alert-text"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <div class="form-check form-switch float-end">
                    Advanced settings
                    <input class="form-check-input" type="checkbox" id="enable-advanced-settings">
                </div>
            </div>
        </div>
        <div class="row">
            <!-- PROBE 1 -->
            <div class="my-2 col-sm-12 col-md-6">
                <div class="card probe" data-probe="1">
                    <div class="card-body py-1 px-2">
                        <div class="row my-1">
                            <div class="col-12">Probe 1</div>
                            <div class="col-6"><small>Target temperature</small></div>
                            <div class="col-6 text-end">
                                <input class="form-control form-control-sm probe-target-temperature" type="text">
                            </div>
                        </div>
                        <div class="row my-1">
                            <div class="col-6"><small>Minimum temperature</small></div>
                            <div class="col-6 text-end">
                                <input class="form-control form-control-sm probe-minimum-temperature" type="text">
                            </div>
                        </div>
                        <div class="row my-1 advanced-settings">
                            <div class="col-6"><small>Probe type</small></div>
                            <div class="col-6 text-end">
                                <select class="form-select form-select-sm probe-type">
                                    <option value="grilleye_iris">Grilleye Iris</option>
                                    <option value="ikea_fantast">Ikea Fantast</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                        </div>
                        <div class="row my-1 advanced-settings">
                            <div class="col-6"><small>Reference kOhm</small></div>
                            <div class="col-6 text-end">
                                <input class="form-control form-control-sm probe-reference-kohm" type="text">
                            </div>
                        </div>
                        <div class="row my-1 advanced-settings">
                            <div class="col-6"><small>Reference kOhm</small></div>
                            <div class="col-6 text-end">
                                <input class="form-control form-control-sm probe-reference-celcius" type="text">
                            </div>
                        </div>
                        <div class="row my-1 advanced-settings">
                            <div class="col-6"><small>Reference kOhm</small></div>
                            <div class="col-6 text-end">
                                <input class="form-control form-control-sm probe-reference-beta" type="text">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- END PROBE 1 -->

            <!-- PROBE 2 -->
            <div class="my-2 col-sm-12 col-md-6">
                <div class="card probe" data-probe="2">
                    <div class="card-body py-1 px-2">
                        <div class="row my-1">
                            <div class="col-12">Probe 2</div>
                            <div class="col-6"><small>Target temperature</small></div>
                            <div class="col-6 text-end">
                                <input class="form-control form-control-sm probe-target-temperature" type="text">
                            </div>
                        </div>
                        <div class="row my-1">
                            <div class="col-6"><small>Minimum temperature</small></div>
                            <div class="col-6 text-end">
                                <input class="form-control form-control-sm probe-minimum-temperature" type="text">
                            </div>
                        </div>
                        <div class="row my-1 advanced-settings">
                            <div class="col-6"><small>Probe type</small></div>
                            <div class="col-6 text-end">
                                <select class="form-select form-select-sm probe-type">
                                    <option value="grilleye_iris">Grilleye Iris</option>
                                    <option value="ikea_fantast">Ikea Fantast</option>
                                    <option value="custom">Custom</option>
                                  </select>
                            </div>
                        </div>
                        <div class="row my-1 advanced-settings">
                            <div class="col-6"><small>Reference kOhm</small></div>
                            <div class="col-6 text-end">
                                <input class="form-control form-control-sm probe-reference-kohm" type="text">
                            </div>
                        </div>
                        <div class="row my-1 advanced-settings">
                            <div class="col-6"><small>Reference kOhm</small></div>
                            <div class="col-6 text-end">
                                <input class="form-control form-control-sm probe-reference-celcius" type="text">
                            </div>
                        </div>
                        <div class="row my-1 advanced-settings">
                            <div class="col-6"><small>Reference kOhm</small></div>
                            <div class="col-6 text-end">
                                <input class="form-control form-control-sm probe-reference-beta" type="text">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- END PROBE 2 -->

            <!-- PROBE 3 -->
            <div class="my-2 col-sm-12 col-md-6">
                <div class="card probe" data-probe="3">
                    <div class="card-body py-1 px-2">
                        <div class="row my-1">
                            <div class="col-12">Probe 3</div>
                            <div class="col-6"><small>Target temperature</small></div>
                            <div class="col-6 text-end">
                                <input class="form-control form-control-sm probe-target-temperature" type="text">
                            </div>
                        </div>
                        <div class="row my-1">
                            <div class="col-6"><small>Minimum temperature</small></div>
                            <div class="col-6 text-end">
                                <input class="form-control form-control-sm probe-minimum-temperature" type="text">
                            </div>
                        </div>
                        <div class="row my-1 advanced-settings">
                            <div class="col-6"><small>Probe type</small></div>
                            <div class="col-6 text-end">
                                <select class="form-select form-select-sm probe-type">
                                    <option value="grilleye_iris">Grilleye Iris</option>
                                    <option value="ikea_fantast">Ikea Fantast</option>
                                    <option value="custom">Custom</option>
                                  </select>
                            </div>
                        </div>
                        <div class="row my-1 advanced-settings">
                            <div class="col-6"><small>Reference kOhm</small></div>
                            <div class="col-6 text-end">
                                <input class="form-control form-control-sm probe-reference-kohm" type="text">
                            </div>
                        </div>
                        <div class="row my-1 advanced-settings">
                            <div class="col-6"><small>Reference kOhm</small></div>
                            <div class="col-6 text-end">
                                <input class="form-control form-control-sm probe-reference-celcius" type="text">
                            </div>
                        </div>
                        <div class="row my-1 advanced-settings">
                            <div class="col-6"><small>Reference kOhm</small></div>
                            <div class="col-6 text-end">
                                <input class="form-control form-control-sm probe-reference-beta" type="text">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- END PROBE 3 -->

            <!-- PROBE 4 -->
            <div class="my-2 col-sm-12 col-md-6">
                <div class="card probe" data-probe="4">
                    <div class="card-body py-1 px-2">
                        <div class="row my-1">
                            <div class="col-12">Probe 4</div>
                            <div class="col-6"><small>Target temperature</small></div>
                            <div class="col-6 text-end">
                                <input class="form-control form-control-sm probe-target-temperature" type="text">
                            </div>
                        </div>
                        <div class="row my-1">
                            <div class="col-6"><small>Minimum temperature</small></div>
                            <div class="col-6 text-end">
                                <input class="form-control form-control-sm probe-minimum-temperature" type="text">
                            </div>
                        </div>
                        <div class="row my-1 advanced-settings">
                            <div class="col-6"><small>Probe type</small></div>
                            <div class="col-6 text-end">
                                <select class="form-select form-select-sm probe-type">
                                    <option value="grilleye_iris">Grilleye Iris</option>
                                    <option value="ikea_fantast">Ikea Fantast</option>
                                    <option value="custom">Custom</option>
                                  </select>
                            </div>
                        </div>
                        <div class="row my-1 advanced-settings">
                            <div class="col-6"><small>Reference kOhm</small></div>
                            <div class="col-6 text-end">
                                <input class="form-control form-control-sm probe-reference-kohm" type="text">
                            </div>
                        </div>
                        <div class="row my-1 advanced-settings">
                            <div class="col-6"><small>Reference kOhm</small></div>
                            <div class="col-6 text-end">
                                <input class="form-control form-control-sm probe-reference-celcius" type="text">
                            </div>
                        </div>
                        <div class="row my-1 advanced-settings">
                            <div class="col-6"><small>Reference kOhm</small></div>
                            <div class="col-6 text-end">
                                <input class="form-control form-control-sm probe-reference-beta" type="text">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- END PROBE 4 -->

            <!-- PROBE 5 -->
            <div class="my-2 col-sm-12 col-md-6">
                <div class="card probe" data-probe="5">
                    <div class="card-body py-1 px-2">
                        <div class="row my-1">
                            <div class="col-12">Probe 5</div>
                            <div class="col-6"><small>Target temperature</small></div>
                            <div class="col-6 text-end">
                                <input class="form-control form-control-sm probe-target-temperature" type="text">
                            </div>
                        </div>
                        <div class="row my-1">
                            <div class="col-6"><small>Minimum temperature</small></div>
                            <div class="col-6 text-end">
                                <input class="form-control form-control-sm probe-minimum-temperature" type="text">
                            </div>
                        </div>
                        <div class="row my-1 advanced-settings">
                            <div class="col-6"><small>Probe type</small></div>
                            <div class="col-6 text-end">
                                <select class="form-select form-select-sm probe-type">
                                    <option value="grilleye_iris">Grilleye Iris</option>
                                    <option value="ikea_fantast">Ikea Fantast</option>
                                    <option value="custom">Custom</option>
                                  </select>
                            </div>
                        </div>
                        <div class="row my-1 advanced-settings">
                            <div class="col-6"><small>Reference kOhm</small></div>
                            <div class="col-6 text-end">
                                <input class="form-control form-control-sm probe-reference-kohm" type="text">
                            </div>
                        </div>
                        <div class="row my-1 advanced-settings">
                            <div class="col-6"><small>Reference kOhm</small></div>
                            <div class="col-6 text-end">
                                <input class="form-control form-control-sm probe-reference-celcius" type="text">
                            </div>
                        </div>
                        <div class="row my-1 advanced-settings">
                            <div class="col-6"><small>Reference kOhm</small></div>
                            <div class="col-6 text-end">
                                <input class="form-control form-control-sm probe-reference-beta" type="text">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- END PROBE 5 -->

            <!-- PROBE 6 -->
            <div class="my-2 col-sm-12 col-md-6">
                <div class="card probe" data-probe="6">
                    <div class="card-body py-1 px-2">
                        <div class="row my-1">
                            <div class="col-12">Probe 6</div>
                            <div class="col-6"><small>Target temperature</small></div>
                            <div class="col-6 text-end">
                                <input class="form-control form-control-sm probe-target-temperature" type="text">
                            </div>
                        </div>
                        <div class="row my-1">
                            <div class="col-6"><small>Minimum temperature</small></div>
                            <div class="col-6 text-end">
                                <input class="form-control form-control-sm probe-minimum-temperature" type="text">
                            </div>
                        </div>
                        <div class="row my-1 advanced-settings">
                            <div class="col-6"><small>Probe type</small></div>
                            <div class="col-6 text-end">
                                <select class="form-select form-select-sm probe-type">
                                    <option value="grilleye_iris">Grilleye Iris</option>
                                    <option value="ikea_fantast">Ikea Fantast</option>
                                    <option value="custom">Custom</option>
                                  </select>
                            </div>
                        </div>
                        <div class="row my-1 advanced-settings">
                            <div class="col-6"><small>Reference kOhm</small></div>
                            <div class="col-6 text-end">
                                <input class="form-control form-control-sm probe-reference-kohm" type="text">
                            </div>
                        </div>
                        <div class="row my-1 advanced-settings">
                            <div class="col-6"><small>Reference kOhm</small></div>
                            <div class="col-6 text-end">
                                <input class="form-control form-control-sm probe-reference-celcius" type="text">
                            </div>
                        </div>
                        <div class="row my-1 advanced-settings">
                            <div class="col-6"><small>Reference kOhm</small></div>
                            <div class="col-6 text-end">
                                <input class="form-control form-control-sm probe-reference-beta" type="text">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- END PROBE 6 -->

            <!-- PROBE 7 -->
            <div class="my-2 col-sm-12 col-md-6">
                <div class="card probe" data-probe="7">
                    <div class="card-body py-1 px-2">
                        <div class="row my-1">
                            <div class="col-12">Probe 7</div>
                            <div class="col-6"><small>Target temperature</small></div>
                            <div class="col-6 text-end">
                                <input class="form-control form-control-sm probe-target-temperature" type="text">
                            </div>
                        </div>
                        <div class="row my-1">
                            <div class="col-6"><small>Minimum temperature</small></div>
                            <div class="col-6 text-end">
                                <input class="form-control form-control-sm probe-minimum-temperature" type="text">
                            </div>
                        </div>
                        <div class="row my-1 advanced-settings">
                            <div class="col-6"><small>Probe type</small></div>
                            <div class="col-6 text-end">
                                <select class="form-select form-select-sm probe-type">
                                    <option value="grilleye_iris">Grilleye Iris</option>
                                    <option value="ikea_fantast">Ikea Fantast</option>
                                    <option value="custom">Custom</option>
                                  </select>
                            </div>
                        </div>
                        <div class="row my-1 advanced-settings">
                            <div class="col-6"><small>Reference kOhm</small></div>
                            <div class="col-6 text-end">
                                <input class="form-control form-control-sm probe-reference-kohm" type="text">
                            </div>
                        </div>
                        <div class="row my-1 advanced-settings">
                            <div class="col-6"><small>Reference kOhm</small></div>
                            <div class="col-6 text-end">
                                <input class="form-control form-control-sm probe-reference-celcius" type="text">
                            </div>
                        </div>
                        <div class="row my-1 advanced-settings">
                            <div class="col-6"><small>Reference kOhm</small></div>
                            <div class="col-6 text-end">
                                <input class="form-control form-control-sm probe-reference-beta" type="text">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- END PROBE 7 -->

            <!-- PROBE 8 -->
            <div class="my-2 col-sm-12 col-md-6">
                <div class="card probe" data-probe="8">
                    <div class="card-body py-1 px-2">
                        <div class="row my-1">
                            <div class="col-12">Probe 8</div>
                            <div class="col-6"><small>Target temperature</small></div>
                            <div class="col-6 text-end">
                                <input class="form-control form-control-sm probe-target-temperature" type="text">
                            </div>
                        </div>
                        <div class="row my-1">
                            <div class="col-6"><small>Minimum temperature</small></div>
                            <div class="col-6 text-end">
                                <input class="form-control form-control-sm probe-minimum-temperature" type="text">
                            </div>
                        </div>
                        <div class="row my-1 advanced-settings">
                            <div class="col-6"><small>Probe type</small></div>
                            <div class="col-6 text-end">
                                <select class="form-select form-select-sm probe-type">
                                    <option value="grilleye_iris">Grilleye Iris</option>
                                    <option value="ikea_fantast">Ikea Fantast</option>
                                    <option value="custom">Custom</option>
                                  </select>
                            </div>
                        </div>
                        <div class="row my-1 advanced-settings">
                            <div class="col-6"><small>Reference kOhm</small></div>
                            <div class="col-6 text-end">
                                <input class="form-control form-control-sm probe-reference-kohm" type="text">
                            </div>
                        </div>
                        <div class="row my-1 advanced-settings">
                            <div class="col-6"><small>Reference kOhm</small></div>
                            <div class="col-6 text-end">
                                <input class="form-control form-control-sm probe-reference-celcius" type="text">
                            </div>
                        </div>
                        <div class="row my-1 advanced-settings">
                            <div class="col-6"><small>Reference kOhm</small></div>
                            <div class="col-6 text-end">
                                <input class="form-control form-control-sm probe-reference-beta" type="text">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- END PROBE 8 -->

        </div>
        <div class="row">
            <div class="col">
                <div class="form-check form-switch float-end">
                    <button id="save-settings" type="button" class="btn btn-primary" disabled>Save settings</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <script type="text/javascript">

        //Only used during tests, the real implementation uses relative urls
        const base_url = "http://10.30.10.235";
       
        e_advanced_settings                = document.getElementsByClassName("advanced-settings");
        e_enable_advanced_settings         = document.getElementById("enable-advanced-settings");
        e_save_settings                    = document.getElementById("save-settings");
        e_alert                            = document.getElementById("alert");
        e_alert_text                       = document.getElementById("alert-text");

        async function getSettings() {
            try {
                const response = await fetch(base_url + "/api/probes");
                data = await response.json();

                data.forEach(probe => {
                    
                    e_probe = document.querySelector('[data-probe="' + probe['probe_id'] +'"]');

                    e_probe.querySelector(".probe-target-temperature").value  = probe["target_temperature"];
                    e_probe.querySelector(".probe-minimum-temperature").value = probe["minimum_temperature"];
                    e_probe.querySelector(".probe-reference-kohm").value      = probe["reference_kohm"];
                    e_probe.querySelector(".probe-reference-celcius").value   = probe["reference_celcius"];
                    e_probe.querySelector(".probe-reference-beta").value      = probe["reference_beta"];
                    e_probe.querySelector(".probe-type").value                = probe["probe_type"];
                });

                // Allow saving once data is loaded
                e_save_settings.disabled = false;


            } catch (error) {
                console.error('Grill is unreachable:', error);
            }
        }
        
        async function postSettings() {
            try {
                e_save_settings.disabled = true;
                
                e_probes = document.querySelectorAll('[data-probe]');

                post_data = [];
    
                e_probes.forEach((e_probe) => {
                    probe_data = {};
    
                    probe_data["probe_id"]            = e_probe.dataset.probe;
                    probe_data["target_temperature"]  = e_probe.querySelector(".probe-target-temperature").value;
                    probe_data["minimum_temperature"] = e_probe.querySelector(".probe-minimum-temperature").value;
                    probe_data["reference_kohm"]      = e_probe.querySelector(".probe-reference-kohm").value;
                    probe_data["reference_celcius"]   = e_probe.querySelector(".probe-reference-celcius").value;
                    probe_data["reference_beta"]      = e_probe.querySelector(".probe-reference-beta").value;
                    probe_data["probe_type"]          = e_probe.querySelector(".probe-type").value;
    
                    post_data.push(probe_data);
                });

                const response = await fetch(base_url + "/api/probes", {
                    method: "POST",
                    body: JSON.stringify(post_data),
                    headers: {
                        "Content-type": "application/json"
                    }
                });

                e_alert.classList.remove("alert-danger");
                e_alert.classList.add("alert-success");
                e_alert_text.textContent = "Settings have been saved successfully";
                e_alert.style.display = 'block';
                
                // Load settings
                getSettings();
                
            } catch (error) {
                e_alert.classList.add("alert-danger");
                e_alert.classList.remove("alert-success");
                e_alert_text.textContent = "Settings could not be saved";
                e_alert.style.display = 'block';

                console.error('Grill is unreachable:', error);
            }
        }

        getSettings();

        e_alert.style.display = 'none';

        for (i = 0; i < e_advanced_settings.length; i++) {
            e_advanced_settings[i].style.display = 'none';
        }

        e_enable_advanced_settings.addEventListener('change', (event) => {
            if (event.currentTarget.checked) {
                for (i = 0; i < e_advanced_settings.length; i++) {
                    e_advanced_settings[i].style.display = 'flex';
                }        
            } else {
                for (i = 0; i < e_advanced_settings.length; i++) {
                    e_advanced_settings[i].style.display = 'none';
                }
            }
        })

        e_save_settings.addEventListener('click', (event) => {
            
            postSettings();
        })


    </script>
  </body>
</html>